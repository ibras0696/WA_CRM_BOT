# CRM WA BOT

Минимальный WhatsApp-интерфейс для учёта рассрочек (Green API). Бот работает как UI, а бизнес-логика и репозитории отделены в сервисный слой и SQLAlchemy/Alembic.

## Стек
- `python 3.12`, `whatsapp-chatbot-python` (Green API)
- async-safe SQLAlchemy + Alembic
- PostgreSQL в Docker
- FSM-логика и кнопки реализованы отдельными обработчиками (handlers)

## Быстрый старт
1. Скопируйте `.env.example` в `.env` и заполните значения (`ID_INSTANCE`, `API_TOKEN`, `ADMIN_PHONE`, `DATABASE_URL`).
2. Постройте и поднимите стек:
   ```bash
   make up
   ```
3. Примените миграции и вставьте администратора:
   ```bash
   make migrate
   make seed
   ```
4. Логика бота сразу начинает обрабатывать сообщения (Green API должен пересылать уведомления на `bot.run_forever`).

## Поддерживаемые команды / текст, который нужно писать
- Отправьте `0` для открытия админ-меню, `1` — меню сотрудника.
- Меню сотрудника: `Открыть смену` (ввести стартовый лимит), `Новая сделка` (имя → телефон → сумма), `Мой баланс`, `Мои сделки`.
- Админ: `Добавить/Отключить сотрудника`, `Корректировка баланса` (дельта по активной смене сотрудника), `Удалить сделку` (soft-delete), `Отчёт` (укажите период и опционально номер сотрудника).

Обработчики вынесены в `crm_bot/handlers`, тексты — в `crm_bot/texts`, кнопки — в `crm_bot/keyboards`, состояния — в `crm_bot/states`.

## Автозакрытие смен
- Скрипт: `python -m crm_bot.scripts.close_shifts` (закрывает все открытые смены).
- Пример cron на хосте: `0 0 * * * cd /Users/ibragim/PycharmProjects/CRM_WA_BOT && docker-compose run --rm app python -m crm_bot.scripts.close_shifts >/tmp/close_shifts.log 2>&1`
- Ручной запуск: `make close-shifts`

## Команды Makefile
- `make build` — соберёт образы
- `make up` / `make down` — поднять/остановить стэк
- `make migrate` — применяет Alembic миграции
- `make seed` — создаёт админа (использует `ADMIN_PHONE`)
- `make logs` — поток логов приложения
- `make shell` — откроет shell внутри контейнера
> Логи (`make logs`) теперь содержат отметки о запуске, входящих сообщениях и результатах транзакций.

## Дальше
1. Привязать Green API webhook (бот изменит настройки сам при старте).
2. Настроить отправку уведомлений (incoming webhook) в `bot.run_forever`.
3. Добавить тесты/метрики, если потребуется расширение beyond MVP.

> Пока номер сотрудника не добавлен администратором, бот игнорирует его сообщения — это нормально.

Документация на ТЗ и FSM-стены описаны в `docs/тз.md`.
