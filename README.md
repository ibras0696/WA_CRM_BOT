# CRM WA BOT

WhatsApp-–±–æ—Ç –¥–ª—è —É—á—ë—Ç–∞ –≤—ã–¥–∞—á/–≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è –ª–∏–º–∏—Ç–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ–≤–µ—Ä—Ö Green API: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –≤ WA, –∞ –≤—Å—è –ª–æ–≥–∏–∫–∞ ‚Äî –≤ —Å–µ—Ä–≤–∏—Å–Ω–æ–º —Å–ª–æ–µ Python + SQLAlchemy.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
2. [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è-–∏-–æ–∫—Ä—É–∂–µ–Ω–∏–µ)
3. [–ó–∞–ø—É—Å–∫ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏](#–∑–∞–ø—É—Å–∫-–∏-–º–∏–≥—Ä–∞—Ü–∏–∏)
4. [–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º](#–∫–∞–∫-–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è-–±–æ—Ç–æ–º)
   - [–û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã](#–æ–±—â–∏–µ-–∫–æ–º–∞–Ω–¥—ã)
   - [–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞](#–ø–∞–Ω–µ–ª—å-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
   - [–ü–∞–Ω–µ–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞](#–ø–∞–Ω–µ–ª—å-—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞)
5. [–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ª–æ–≥–∏–∫–∞](#—Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è-–ª–æ–≥–∏–∫–∞)
6. [–û—Ç—á—ë—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞](#–æ—Ç—á—ë—Ç—ã-–∏-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞)
7. [–ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω](#–∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ-—Å–º–µ–Ω)
8. [–°–µ—Ä–≤–∏—Å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞](#—Å–µ—Ä–≤–∏—Å–Ω—ã–µ-–∫–æ–º–∞–Ω–¥—ã-–∏-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
9. [–¢—Ä–∞–±–ª—à—É—Ç–∏–Ω–≥](#—Ç—Ä–∞–±–ª—à—É—Ç–∏–Ω–≥)

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **Green API** ‚Üí —Å–æ–±—ã—Ç–∏—è incoming/outgoing –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–µ `whatsapp-chatbot-python`.
- **FSM-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** (`crm_bot/handlers`) –æ—Ç–≤–µ—á–∞—é—Ç –∑–∞ —Å—Ü–µ–Ω–∞—Ä–∏–∏: –º–µ–Ω—é, –æ–ø–µ—Ä–∞—Ü–∏–∏, –æ—Ç—á—ë—Ç—ã.
- **–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π** (`crm_bot/services`) —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞: –ª–∏–º–∏—Ç—ã, –æ–ø–µ—Ä–∞—Ü–∏–∏, –æ—Ç—á—ë—Ç—ã.
- **PostgreSQL** + SQLAlchemy ORM + Alembic –º–∏–≥—Ä–∞—Ü–∏–∏.
- **Docker Compose** –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è, Makefile ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã.
- **–ê–≤—Ç–æ–∑–∞–¥–∞—á–∏** (–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω) –æ—Ñ–æ—Ä–º–ª–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Å–∫—Ä–∏–ø—Ç–∞–º–∏ (`crm_bot/scripts`).

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- Python 3.12
- Docker + Docker Compose
- Green API –∞–∫–∫–∞—É–Ω—Ç –∏ —Ç–æ–∫–µ–Ω

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` ‚Üí `.env`.

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è        | –û–ø–∏—Å–∞–Ω–∏–µ                                              |
|-------------------|-------------------------------------------------------|
| `ID_INSTANCE`     | ID –∏–Ω—Å—Ç–∞–Ω—Å–∞ Green API                                 |
| `API_TOKEN`       | API Token                                             |
| `DATABASE_URL`    | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL (`postgresql+psycopg://...`) |
| `ADMIN_PHONE`     | –ù–æ–º–µ—Ä –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (`7XXXXXXXXXX`)         |
| `ADMIN_PHONES`    | (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Å–ø–∏—Å–æ–∫ –Ω–æ–º–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é            |
| `COMPANY_NAME`    | –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ                                 |
| `BOT_DEBUG`       | `True/False` ‚Äî —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–æ–≤                          |
| `GREEN_API_HOST`  | URL Green API                                         |
| `GREEN_API_MEDIA` | URL –¥–ª—è –º–µ–¥–∏–∞                                         |

## –ó–∞–ø—É—Å–∫ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
make build         # —Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã (–æ–¥–∏–Ω —Ä–∞–∑)
make up            # docker-compose up
make migrate       # alembic upgrade head
make seed          # —Å–æ–∑–¥–∞—ë—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç ADMIN_PHONE)
```

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ `make up` –±–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `crm_bot.main:bot.run_forever`, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤ Green API –∏ –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.

## –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º

### –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã
- `0` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ whitelisted –Ω–æ–º–µ—Ä–∞).
- `1` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–æ–º).
- `help` / `–º–µ–Ω—é` / `–ø–æ–º–æ—â—å` ‚Äî –±–æ—Ç –ø—Ä–∏—à–ª—ë—Ç —Ä–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—É—é –ø–∞–º—è—Ç–∫—É —Å –ø–æ—à–∞–≥–æ–≤—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤.
- –ù–∞ –ª—é–±–æ–º —à–∞–≥–µ FSM –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `0` –∏–ª–∏ `1`, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω—É–∂–Ω–æ–µ –º–µ–Ω—é; `–æ—Ç–º–µ–Ω–∞` –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –º–µ–Ω—é.

### –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
–î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ whitelisted –Ω–æ–º–µ—Ä–∞–º (—É–∫–∞–∑–∞–Ω–Ω—ã–º –≤ `ADMIN_PHONE(S)`). –ö–Ω–æ–ø–∫–∏:

1. **–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞** ‚Äî –≤–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ `7XXXXXXXXXX`, –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É.
2. **–û—Ç–∫–ª—é—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞** ‚Äî –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ –Ω–æ–º–µ—Ä—É, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –±–æ–ª—å—à–µ –Ω–µ —Å–º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é.
3. **–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –±–∞–ª–∞–Ω—Å–∞** ‚Äî –∑–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ ‚Üí —Å—É–º–º–∞ (–º–æ–∂–Ω–æ `+` –∏–ª–∏ `-`). –ò–∑–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–π –ª–∏–º–∏—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞—Å—Å–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è.
4. **–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é** ‚Äî –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ ID. –ó–∞–ø–∏—Å—å –ø–æ–ª—É—á–∞–µ—Ç `is_deleted = true`, –±–∞–ª–∞–Ω—Å –Ω–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è.
5. **–û—Ç—á—ë—Ç** ‚Äî —Ñ–æ—Ä–º–∞—Ç `YYYY-MM-DD [YYYY-MM-DD] [–Ω–æ–º–µ—Ä]`. –ë–µ–∑ –Ω–æ–º–µ—Ä–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ–±—â–∏–π –æ—Ç—á—ë—Ç –ø–æ –≤—Å–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π (–≤—ã–¥–∞—á–∏/–≤–æ–∑–≤—Ä–∞—Ç—ã/–∏—Ç–æ–≥, –Ω–∞–ª–∏—á–∫–∞/–±–∞–Ω–∫). –° –Ω–æ–º–µ—Ä–æ–º ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç.
6. **–û—Ç—á—ë—Ç –∑–∞ –¥–µ–Ω—å** ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–¥–∫—É –∑–∞ —Ç–µ–∫—É—â–∏–µ —Å—É—Ç–∫–∏ (–ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏).
7. **–ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç** ‚Äî –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ ¬´–ó–∞ –¥–µ–Ω—å / –ó–∞ –º–µ—Å—è—Ü / –ó–∞ –≥–æ–¥ / –ü–µ—Ä–∏–æ–¥¬ª –∏ —Å—Ç—Ä–æ–∏—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –æ—Ç—á—ë—Ç —Å –æ–±–æ—Ä–æ—Ç–æ–º, –ø—Ä–∏—Ö–æ–¥–∞–º–∏/—Ä–∞—Å—Ö–æ–¥–∞–º–∏ –∏ —Ä–∞–∑—Ä–µ–∑–æ–º –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º.

### –ü–∞–Ω–µ–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–æ–º. –ö–Ω–æ–ø–∫–∏:

1. **–û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É** ‚Äî –±–æ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –ª–∏–º–∏—Ç –ø–æ –Ω–∞–ª–∏—á–∫–µ –∏ –±–∞–Ω–∫—É (–ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫ –ø—Ä–æ—à–ª–æ–π —Å–º–µ–Ω—ã). –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `+`, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É.
2. **–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É** ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Å–º–µ–Ω—É –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏.
3. **–í—ã–¥–∞—á–∞ —Ä–∞—Å—Å—Ä–æ—á–∫–∏** ‚Äî –≤–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞, –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞—Ü–µ–Ω–∫–∏ –∏ —Å—Ä–æ–∫; –±–æ—Ç –ø–æ—Å—á–∏—Ç–∞–µ—Ç –Ω–∞—Ü–µ–Ω–∫—É, –ø–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å, —Å—É–º–º—É —Ä–∞—Å—Å—Ä–æ—á–∫–∏ –∏ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂, –∞ –ª–∏–º–∏—Ç —É–º–µ–Ω—å—à–∏—Ç –Ω–∞ —Å—É–º–º—É –≤—ã–¥–∞—á–∏.
4. **–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è** ‚Äî –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (`+` –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ, `-` —Ä–∞—Å—Ö–æ–¥) –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± (`–ù–∞–ª–∏—á–∫–∞` –∏–ª–∏ `–ë–∞–Ω–∫`). –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–æ—Ç –ø–æ–∫–∞–∂–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å.
5. **–ú–æ–π –±–∞–ª–∞–Ω—Å** ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –Ω–∞–ª–∏—á–∫–µ, –±–∞–Ω–∫—É –∏ –æ–±—â–∏–π –ª–∏–º–∏—Ç.
6. **–ú–æ–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏** ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (—Ç–∏–ø, —Å—É–º–º–∞, —Å–ø–æ—Å–æ–±). –ü–æ—Å–ª–µ —Å–ø–∏—Å–∫–∞ –º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ `#123` –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ `123`, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏, –ª–∏–±–æ `0`, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é.

–õ—é–±–æ–π –Ω–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –ø–æ–ª—É—á–∏—Ç –æ—Ç–≤–µ—Ç ¬´–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –î–æ—Å—Ç—É–ø –≤—ã–¥–∞—ë—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä¬ª.

## –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
- –ö–∞–∂–¥–∞—è —Å–º–µ–Ω–∞ (`Shift`) –∏–º–µ–µ—Ç `opening_balance` –∏ `current_balance`.
- –°–º–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏; –æ—Å—Ç–∞—Ç–æ–∫ –ø—Ä–æ—à–ª–æ–≥–æ –¥–Ω—è –±–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏.
- –û–ø–µ—Ä–∞—Ü–∏—è (`Deal`) —Å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π —Å—É–º–º–æ–π –ø–æ–ø–æ–ª–Ω—è–µ—Ç –±–∞–ª–∞–Ω—Å (–ø—Ä–∏—Ö–æ–¥), —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π ‚Äî —Å–ø–∏—Å—ã–≤–∞–µ—Ç –ª–∏–º–∏—Ç. –•—Ä–∞–Ω–∏—Ç—Å—è —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (`–Ω–∞–ª–∏—á–∫–∞` / `–±–∞–Ω–∫`) –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
- –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∞ —Å–æ–∑–¥–∞—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (`CashTransaction`).
- Soft-delete –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–∏–º–∏—Ç ‚Äî —ç—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å –æ—Ç–º–µ—Ç–∫–∞ –≤ –æ—Ç—á—ë—Ç–∞—Ö.

## –û—Ç—á—ë—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
–ö–æ–º–∞–Ω–¥–∞ ¬´–û—Ç—á—ë—Ç¬ª –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
```
üìä –û—Ç—á—ë—Ç 01.01.2025 ‚Äî 31.01.2025
–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π: 12
üí∏ –í—ã–¥–∞—á–∏: 1 200 000.00 (—à—Ç. 8)
‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—Ç—ã: 150 000.00 (—à—Ç. 3)
üßÆ –ò—Ç–æ–≥: 1 050 000.00
–ù–∞–ª–∏—á–∫–∞: 700 000.00 (—à—Ç. 5)
–ë–∞–Ω–∫: 350 000.00 (—à—Ç. 3)

üë• –ü–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º:
‚Ä¢ –ò–≤–∞–Ω: –≤—ã–¥–∞—á–∏ 600 000.00 (—à—Ç. 4), –≤–æ–∑–≤—Ä–∞—Ç—ã 50 000.00 (—à—Ç. 1), –∏—Ç–æ–≥ 550 000.00 | –Ω–∞–ª 400 000.00 / –±–∞–Ω–∫ 150 000.00
‚Ä¢ –û–ª—å–≥–∞: –≤—ã–¥–∞—á–∏ 600 000.00 (—à—Ç. 4), –≤–æ–∑–≤—Ä–∞—Ç—ã 100 000.00 (—à—Ç. 2), –∏—Ç–æ–≥ 500 000.00 | –Ω–∞–ª 300 000.00 / –±–∞–Ω–∫ 150 000.00
```
–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –≤—ã–≤–æ–¥—è—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏ ¬´–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π / –í—ã–¥–∞—á–∏ / –í–æ–∑–≤—Ä–∞—Ç—ã / –ò—Ç–æ–≥ / üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫¬ª.

–ï—Å–ª–∏ –Ω—É–∂–µ–Ω —ç–∫—Å–ø—Ä–µ—Å—Å-—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–û—Ç—á—ë—Ç –∑–∞ –¥–µ–Ω—å¬ª –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ ‚Äî –±–æ—Ç –ø–æ—Å—á–∏—Ç–∞–µ—Ç —Ç–µ –∂–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∑–∞ —Ç–µ–∫—É—â–∏–µ —Å—É—Ç–∫–∏ –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏.

–ö–Ω–æ–ø–∫–∞ ¬´–ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç¬ª –¥–∞—ë—Ç –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Å–≤–æ–¥–∫–µ (–æ–±–æ—Ä–æ—Ç, –ø—Ä–∏—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥, –Ω–∞–ª–∏—á–∫–∞/–±–∞–Ω–∫, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏) –∑–∞ –¥–µ–Ω—å, –º–µ—Å—è—Ü, –≥–æ–¥ –∏–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω.

## –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω
–í—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–º–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ 00:00 (Europe/Moscow) –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º:
```bash
python -m crm_bot.scripts.close_shifts
```
–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è cron (–ø—Ä–∏–º–µ—Ä):
```
0 0 * * * cd /path/to/CRM_WA_BOT && \
  docker-compose run --rm app python -m crm_bot.scripts.close_shifts \
  >/tmp/close_shifts.log 2>&1
```
–ö–æ–º–∞–Ω–¥–∞ `make close-shifts` –¥–µ–ª–∞–µ—Ç —Ç–æ –∂–µ —Å–∞–º–æ–µ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

## –°–µ—Ä–≤–∏—Å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- `make logs` ‚Äî –ø–æ—Ç–æ–∫ –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–≤–∫–ª—é—á–∞—è –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —É—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏).
- `make shell` ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π shell –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- `pytest` ‚Äî —Ç–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–ª–æ—è –∏ FSM (—Å–º. `tests/`).
- `alembic revision --autogenerate -m "..."` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π:
```
crm_bot/
 ‚îú‚îÄ‚îÄ handlers/         # –º–µ–Ω—é, FSM-–ª–æ–≥–∏–∫–∞
 ‚îú‚îÄ‚îÄ services/         # –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞
 ‚îú‚îÄ‚îÄ core/             # DB, –º–æ–¥–µ–ª–∏
 ‚îú‚îÄ‚îÄ scripts/          # —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
 ‚îî‚îÄ‚îÄ main.py           # —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤ Green API
```

## –¢—Ä–∞–±–ª—à—É—Ç–∏–Ω–≥
- **–ë–æ—Ç –º–æ–ª—á–∏—Ç.** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–∞—à –Ω–æ–º–µ—Ä –≤ —Å–ø–∏—Å–∫–µ –∞–¥–º–∏–Ω–æ–≤/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.
- **–ù–µ –ø–æ–º–Ω—é, —á—Ç–æ –Ω–∞–∂–∏–º–∞—Ç—å.** –ù–∞–ø–∏—à–∏—Ç–µ `help` ‚Äî –±–æ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç –±–æ–ª—å—à—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏.
- **–ù—É–∂–Ω–æ –ø—Ä–µ—Ä–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π.** –û—Ç–ø—Ä–∞–≤—å—Ç–µ `0` –∏–ª–∏ `1` –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é (—Å–±—Ä–æ—Å–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ) –∏–ª–∏ `–æ—Ç–º–µ–Ω–∞` ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–∫–æ–Ω—á–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π.
- **–ê–¥–º–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.** –ö–æ–º–∞–Ω–¥–∞ `make seed` –∏–ª–∏ –ª—é–±–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ whitelisted –Ω–æ–º–µ—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç/–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
- **–°–º–µ–Ω—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è.** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ cron/`make close-shifts` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ; –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–ø–∏—Å—å –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–º–µ–Ω.
- **–ù—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç –ø–æ—Å–ª–µ soft-delete.** Soft-delete –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏; –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ¬´–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –±–∞–ª–∞–Ω—Å–∞¬ª.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ `docs/—Ç–∑.md`.
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞/–º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ ‚Äî `docs/customer-guide.md`.
